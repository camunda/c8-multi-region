---
name: reusable_teleport_operational_procedure

on:
    push:
        branches:
            - reusable-gh-workflow

permissions:
    contents: read
    id-token: write

env:
    AWS_PROFILE: infex
    TESTS_TF_BINARY_NAME: terraform
    NAMESPACE_PREFIX: infraex-
    CLUSTER_NAME: camunda-ci-eks
    LABELS: janitor/ttl=1h,camunda.cloud/ephemeral=true

jobs:
    teleport-setup:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Teleport
              uses: teleport-actions/setup@v1
              with:
                  version: 16.4.11

            - name: Authenticate with Teleport
              uses: teleport-actions/auth-k8s@v2
              with:
                  proxy: camunda.teleport.sh:443
                  token: infra-ci-prod-github-action-infraex
                  kubernetes-cluster: camunda-ci-eks

            - name: Write kubeconfig file
              id: write-kubeconfig
              run: |
                  KUBECONFIG_PATH=./test/kubeconfig
                  kubectl config view --raw > $KUBECONFIG_PATH

            - name: Create namespaces
              id: create-namespaces
              run: |
                  RANDOM_ID=$(openssl rand -hex 3)
                  NAMESPACE0="${{ env.NAMESPACE_PREFIX }}${RANDOM_ID}-cluster0"
                  NAMESPACE1="${{ env.NAMESPACE_PREFIX }}${RANDOM_ID}-cluster1"
                  kubectl create namespace $NAMESPACE0
                  kubectl label namespace $NAMESPACE0 ${{ env.LABELS }}
                  kubectl create namespace $NAMESPACE1
                  kubectl label namespace $NAMESPACE1 ${{ env.LABELS }}
                  echo "::set-output name=namespace0::$NAMESPACE0"
                  echo "::set-output name=namespace1::$NAMESPACE1"

            - name: Hello World in namespaces
              run: |
                  kubectl run hello-world --image=busybox --namespace=${{ steps.create-namespaces.outputs.namespace0 }} \
                    --labels=${{ env.LABELS }} -- /bin/sh -c "echo Hello, World!"
                  kubectl run hello-world --image=busybox --namespace=${{ steps.create-namespaces.outputs.namespace1 }} \
                    --labels=${{ env.LABELS }} -- /bin/sh -c "echo Hello, World!"

            - name: Delete namespaces
              run: |
                  kubectl delete namespace ${{ steps.create-namespaces.outputs.namespace0 }}
                  kubectl delete namespace ${{ steps.create-namespaces.outputs.namespace1 }}

            - name: Start tmate session
              uses: mxschmitt/action-tmate@v3
